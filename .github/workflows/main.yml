name: Build Sonic3AIR iOS

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-latest

    env:
      XCODE_DIR: Oxygen/sonic3air/build/_xcode

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------
    # Dependencies
    # -------------------------------------------------
    - name: Install dependencies
      run: |
        brew update
        brew install \
          sdl2 \
          libogg \
          libvorbis \
          curl \
          zlib

    # -------------------------------------------------
    # Build End User command-line tool (CI-safe)
    # -------------------------------------------------
    - name: Build sonic3air_cmd
      run: |
        cd "$XCODE_DIR"

        mkdir -p build

        xcodebuild \
          -project sonic3air.xcodeproj \
          -scheme sonic3air_cmd \
          -configuration Release \
          -sdk macosx \
          -destination 'platform=macOS,arch=arm64' \
          SYMROOT="$PWD/build" \
          build

    # -------------------------------------------------
    # Package game data (requires legal game files)
    # -------------------------------------------------
    - name: Package game data
      run: |
        cd "$XCODE_DIR"
        ./build/Release/sonic3air_cmd -pack

    # -------------------------------------------------
    # Prepare iOS bundle data
    # -------------------------------------------------
    - name: Prepare data folder
      run: |
        cd "$XCODE_DIR"

        mkdir -p data

        cp gamedata.bin data/
        cp enginedata.bin data/
        cp audiodata.bin data/
        cp audioremaster.bin data/
        cp saves/scripts.bin data/

    # -------------------------------------------------
    # Build iOS archive (unsigned)
    # -------------------------------------------------
    - name: Build iOS archive
      run: |
        cd "$XCODE_DIR"

        xcodebuild \
          -project sonic3air.xcodeproj \
          -scheme sonic3air-ios \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          clean archive \
          -archivePath s3airios.xcarchive \
          SYMROOT="$PWD/build" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    # -------------------------------------------------
    # Upload result
    # -------------------------------------------------
    - name: Upload iOS xcarchive
      uses: actions/upload-artifact@v4
      with:
        name: sonic3air-ios-xcarchive
        path: Oxygen/sonic3air/build/_xcode/s3airios.xcarchive
